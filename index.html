<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TD Analytics">
    <meta name="theme-color" content="#050508">
    
    <!-- Temporary CSP to help debug — remove once extensions issue is resolved -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https://*.googleapis.com https://apis.google.com https://accounts.google.com;
        script-src 'self' 'unsafe-inline' https://apis.google.com https://accounts.google.com https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://*.googleapis.com https://analyticsdata.googleapis.com https://www.googleapis.com;
        img-src 'self' data:;
    ">
    
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <title>TD Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Your existing long <style> block here – keeping it unchanged -->
    <style>
        /* Paste your full :root, layout, cards, etc. CSS here – omitted for brevity */
        :root { --bg-primary: #050508; /* ... rest of your variables */ }
        /* ... your complete CSS ... */
    </style>
</head>
<body>
    <!-- Your full HTML structure here – keeping it unchanged -->
    <div class="app-container">
        <!-- header, date-selector, filters-row, auth-screen, dashboard, settings-panel, loadingState, filter-modal, tab-bar -->
        <!-- Paste your complete HTML body content here – omitted for brevity -->
        
        <!-- Add this error banner right after auth-screen for visibility -->
        <div id="apiErrorBanner" style="display:none; background:#ff4757; color:white; padding:16px; margin:20px; border-radius:8px; text-align:center;">
            <strong>API Initialization Failed</strong><br>
            <span id="apiErrorMessage">Check console (F12) for details. Common fixes: enable Analytics Data API, check API key restrictions, try Incognito.</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // ============================================
        // TD Analytics Pro – FIXED VERSION (Jan 2026)
        // ============================================

        const CONFIG = {
            CLIENT_ID: '89616736300-derj13fmb1dp057t1q10tpo4f8nhgbka.apps.googleusercontent.com',
            API_KEY: 'AIzaSyATDAD6FgtvyX4GZHOKrxPzlQ06aDBu5-c',
            PROPERTY_ID: 'properties/512310601',
            SCOPES: 'https://www.googleapis.com/auth/analytics.readonly',
            DISCOVERY_DOC: 'https://analyticsdata.googleapis.com/$discovery/rest?version=v1beta'
        };

        const state = {
            isSignedIn: false,
            currentRange: 'today',
            analyticsData: null,
            trafficChart: null,
            lastSync: null,
            filters: { country: null, city: null, source: null },
            filterOptions: { countries: [], cities: [], sources: [] },
            activeFilterType: null
        };

        const dateRanges = {
            'today': { days: 0, label: 'Today', compare: 1 },
            '7d': { days: 7, label: 'Last 7 Days', compare: 7 },
            '28d': { days: 28, label: 'Last 28 Days', compare: 28 },
            '90d': { days: 90, label: 'Last 90 Days', compare: 90 },
            'ytd': { days: 'ytd', label: 'Year to Date', compare: 'ytd' }
        };

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // ── IMPROVED API INITIALIZATION ────────────────────────────────────────
        function initGoogleAPIs() {
            if (typeof gapi === 'undefined' || typeof google === 'undefined') {
                setTimeout(initGoogleAPIs, 200);
                return;
            }

            // Load gapi.client
            gapi.load('client', async () => {
                try {
                    console.log('Starting GAPI client init...');
                    await gapi.client.init({
                        apiKey: CONFIG.API_KEY,
                        discoveryDocs: [CONFIG.DISCOVERY_DOC]
                    });

                    // Explicitly load the discovery doc again if needed
                    if (!gapi.client.analyticsdata) {
                        console.log('AnalyticsData not found – forcing load...');
                        await gapi.client.load('analyticsdata', 'v1beta');
                    }

                    console.log('GAPI + Analytics Data API successfully initialized!');
                    gapiInited = true;
                    maybeEnableButtons();
                } catch (err) {
                    console.error('GAPI / Analytics Data API init failed:', err);
                    const msg = err.result?.error?.message || err.message || 'Unknown error';
                    document.getElementById('apiErrorMessage').textContent = `API init failed: ${msg}`;
                    document.getElementById('apiErrorBanner').style.display = 'block';
                }
            });

            // Google Identity Services
            if (typeof google !== 'undefined' && google.accounts) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.CLIENT_ID,
                    scope: CONFIG.SCOPES,
                    callback: (resp) => {
                        if (resp.error) {
                            console.error('OAuth error:', resp);
                            return;
                        }
                        localStorage.setItem('ga_token', resp.access_token);
                        localStorage.setItem('ga_token_expiry', Date.now() + (resp.expires_in * 1000));
                        handleSignIn();
                    }
                });
                gisInited = true;
                maybeEnableButtons();
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const token = localStorage.getItem('ga_token');
                const expiry = localStorage.getItem('ga_token_expiry');
                if (token && expiry && Date.now() < parseInt(expiry)) {
                    gapi.client.setToken({ access_token: token });
                    handleSignIn();
                }
            }
        }

        // ── Rest of your code (auth handlers, fetchAnalyticsData, parsing, rendering, etc.) ──
        // Paste the rest of your <script> content here (handleAuthClick, handleSignIn, fetchAnalyticsData, parseGA4Response, render functions, event listeners, etc.)
        // ... (your existing functions go here) ...

        // DOM ready – start init
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('signInBtn').addEventListener('click', handleAuthClick);
            document.getElementById('signOutBtn').addEventListener('click', handleSignOut);
            // ... your other listeners ...

            // Start API init with small delay to ensure scripts loaded
            setTimeout(initGoogleAPIs, 500);
        });

        // Fallback on window load
        window.addEventListener('load', () => setTimeout(initGoogleAPIs, 1000));
    </script>
</body>
</html>
