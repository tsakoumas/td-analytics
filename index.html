<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TD Analytics">
    <meta name="theme-color" content="#050508">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <title>TD Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --bg-primary: #050508;
            --bg-secondary: #0a0a10;
            --bg-card: #0f0f18;
            --bg-card-hover: #161622;
            --text-primary: #f5f5fa;
            --text-secondary: #9090a8;
            --text-muted: #505068;
            --accent-cyan: #00e5ff;
            --accent-purple: #9945ff;
            --accent-green: #00d68f;
            --accent-red: #ff4757;
            --accent-orange: #ffa502;
            --accent-pink: #ff6b9d;
            --gradient-primary: linear-gradient(135deg, #9945ff 0%, #00e5ff 100%);
            --gradient-subtle: linear-gradient(135deg, rgba(153, 69, 255, 0.12) 0%, rgba(0, 229, 255, 0.06) 100%);
            --gradient-card: linear-gradient(160deg, rgba(153, 69, 255, 0.08) 0%, rgba(0, 229, 255, 0.03) 100%);
            --border-color: rgba(153, 69, 255, 0.12);
            --border-glow: rgba(0, 229, 255, 0.2);
            --shadow-glow: 0 0 60px rgba(153, 69, 255, 0.2);
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 24px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Outfit', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; -webkit-font-smoothing: antialiased; }
        .app-container { height: 100%; display: flex; flex-direction: column; padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); }
        .header { padding: 16px 20px; background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-mark { width: 36px; height: 36px; background: var(--gradient-primary); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 13px; position: relative; box-shadow: 0 4px 20px rgba(153, 69, 255, 0.3); }
        .logo-mark::after { content: ''; position: absolute; bottom: 4px; left: 6px; right: 6px; height: 2px; background: rgba(255,255,255,0.4); border-radius: 1px; }
        .logo-text { font-weight: 700; font-size: 17px; letter-spacing: -0.5px; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo-text span { background: none; -webkit-text-fill-color: var(--text-secondary); font-weight: 400; }
        .header-actions { display: flex; gap: 12px; }
        .icon-btn { width: 40px; height: 40px; border-radius: var(--radius-sm); background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .icon-btn:hover, .icon-btn:active { background: var(--bg-card-hover); color: var(--text-primary); }
        .icon-btn.active { background: var(--accent-purple); color: white; border-color: var(--accent-purple); }
        .date-selector { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding-bottom: 4px; }
        .date-selector::-webkit-scrollbar { display: none; }
        .date-chip { padding: 8px 14px; border-radius: 20px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .date-chip:hover, .date-chip.active { background: var(--accent-purple); color: white; border-color: var(--accent-purple); }
        .filters-row { display: flex; gap: 8px; margin-top: 12px; overflow-x: auto; scrollbar-width: none; padding-bottom: 4px; }
        .filters-row::-webkit-scrollbar { display: none; }
        .filter-dropdown { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .filter-dropdown:hover { border-color: var(--accent-purple); }
        .filter-dropdown.active { border-color: var(--accent-cyan); background: rgba(0, 229, 255, 0.08); }
        .filter-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; }
        .filter-value { font-size: 13px; font-weight: 500; color: var(--text-primary); }
        .filter-clear { padding: 8px 14px; background: transparent; border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .filter-clear:hover { color: var(--accent-red); border-color: var(--accent-red); }
        .filter-modal { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top-left-radius: var(--radius-lg); border-top-right-radius: var(--radius-lg); padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); z-index: 200; transform: translateY(100%); transition: transform 0.3s ease-out; max-height: 60vh; overflow-y: auto; }
        .filter-modal.open { transform: translateY(0); }
        .filter-modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 199; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .filter-modal-backdrop.open { opacity: 1; pointer-events: auto; }
        .filter-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .filter-modal-title { font-size: 16px; font-weight: 600; }
        .filter-option { padding: 14px; border-radius: var(--radius-sm); cursor: pointer; transition: background 0.15s; }
        .filter-option:hover { background: var(--bg-card); }
        .filter-option.selected { background: rgba(153, 69, 255, 0.15); color: var(--accent-purple); }
        .main-content { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; padding-bottom: calc(80px + var(--safe-bottom)); }
        .auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 40px 20px; }
        .auth-icon { width: 80px; height: 80px; background: var(--gradient-card); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; border: 1px solid var(--border-color); }
        .auth-icon svg { width: 40px; height: 40px; color: var(--accent-purple); }
        .auth-title { font-size: 24px; font-weight: 600; margin-bottom: 12px; letter-spacing: -0.5px; }
        .auth-subtitle { color: var(--text-secondary); font-size: 15px; max-width: 280px; margin-bottom: 32px; }
        .auth-btn { display: flex; align-items: center; gap: 12px; padding: 14px 28px; background: white; color: #333; border: none; border-radius: var(--radius-md); font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(255, 255, 255, 0.2); }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-primary); opacity: 0; transition: opacity 0.3s; }
        .stat-card:hover::before { opacity: 1; }
        .stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; font-family: 'JetBrains Mono', monospace; }
        .stat-change { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 500; margin-top: 8px; padding: 4px 8px; border-radius: 4px; }
        .stat-change.positive { color: var(--accent-green); background: rgba(16, 185, 129, 0.1); }
        .stat-change.negative { color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
        .stat-change.neutral { color: var(--text-secondary); background: rgba(136, 136, 160, 0.1); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-title { font-size: 18px; font-weight: 600; letter-spacing: -0.3px; }
        .insights-section { margin-bottom: 24px; }
        .insight-card { background: var(--gradient-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; position: relative; overflow: hidden; }
        .insight-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .insight-card.critical::before { background: var(--accent-red); }
        .insight-card.warning::before { background: var(--accent-orange); }
        .insight-card.success::before { background: var(--accent-green); }
        .insight-card.info::before { background: var(--accent-cyan); }
        .insight-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 10px; border-radius: 4px; margin-bottom: 10px; }
        .insight-card.critical .insight-badge { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .insight-card.warning .insight-badge { background: rgba(245, 158, 11, 0.15); color: var(--accent-orange); }
        .insight-card.success .insight-badge { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .insight-card.info .insight-badge { background: rgba(0, 212, 255, 0.15); color: var(--accent-cyan); }
        .insight-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
        .insight-detail { font-size: 13px; color: var(--text-secondary); line-height: 1.6; }
        .insight-metric { font-family: 'JetBrains Mono', monospace; color: var(--text-primary); font-weight: 500; }
        .chart-section { margin-bottom: 24px; }
        .chart-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; height: 220px; position: relative; }
        .chart-canvas { width: 100%; height: 100%; }
        .data-table-section { margin-bottom: 24px; }
        .data-table { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); overflow: hidden; }
        .table-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--border-color); }
        .table-row:last-child { border-bottom: none; }
        .table-label { display: flex; align-items: center; gap: 10px; }
        .table-rank { width: 24px; height: 24px; background: var(--bg-secondary); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }
        .table-name { font-size: 14px; font-weight: 500; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .table-value { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 500; color: var(--accent-cyan); }
        .geo-section { margin-bottom: 24px; }
        .geo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .geo-card { background: var(--gradient-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; }
        .geo-card-title { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .geo-card-title svg { width: 14px; height: 14px; color: var(--accent-cyan); }
        .geo-list { list-style: none; }
        .geo-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .geo-item:last-child { border-bottom: none; }
        .geo-item-name { font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .geo-flag { font-size: 16px; }
        .geo-item-value { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--accent-cyan); }
        .geo-map-preview { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; position: relative; overflow: hidden; min-height: 80px; }
        .geo-hotspots { position: relative; z-index: 1; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .geo-hotspot { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: rgba(153, 69, 255, 0.15); border: 1px solid var(--border-color); border-radius: 20px; font-size: 12px; }
        .geo-hotspot-dot { width: 8px; height: 8px; background: var(--accent-cyan); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } }

        /* Section Analytics Styles */
        .section-analytics-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 24px; }
        .section-row { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .section-row:hover { border-color: var(--accent-purple); background: var(--bg-card-hover); }
        .section-row-left { display: flex; flex-direction: column; gap: 4px; flex: 1; }
        .section-row-name { font-size: 15px; font-weight: 600; text-transform: capitalize; }
        .section-row-bar { height: 4px; background: var(--bg-secondary); border-radius: 2px; margin-top: 6px; overflow: hidden; max-width: 200px; }
        .section-row-bar-fill { height: 100%; background: var(--gradient-primary); border-radius: 2px; transition: width 0.6s ease-out; }
        .section-row-right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
        .section-row-count { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 700; color: var(--accent-cyan); }
        .section-row-pct { font-size: 12px; color: var(--text-secondary); }
        .section-breakdown { margin-top: 24px; }
        .section-breakdown-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .section-breakdown-card { background: var(--gradient-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; }
        .section-breakdown-title { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .section-breakdown-list { list-style: none; }
        .section-breakdown-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        .section-breakdown-item:last-child { border-bottom: none; }
        .section-breakdown-item-val { font-family: 'JetBrains Mono', monospace; color: var(--accent-cyan); font-size: 13px; }
        .section-empty { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .section-empty-icon { font-size: 48px; margin-bottom: 16px; }
        .section-empty-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .section-empty-detail { font-size: 14px; line-height: 1.6; max-width: 300px; margin: 0 auto; }

        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); padding: 8px 12px; padding-bottom: calc(8px + var(--safe-bottom)); display: flex; justify-content: space-around; z-index: 100; }
        .tab-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); text-decoration: none; cursor: pointer; transition: all 0.2s; padding: 6px 10px; border-radius: var(--radius-sm); }
        .tab-item:hover, .tab-item.active { color: var(--accent-purple); }
        .tab-item.active { background: rgba(139, 92, 246, 0.1); }
        .tab-icon { width: 22px; height: 22px; }
        .tab-label { font-size: 10px; font-weight: 500; }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--accent-purple); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; color: var(--text-secondary); font-size: 14px; }
        .view-hidden { display: none !important; }
        .settings-panel { padding: 20px 0; }
        .settings-group { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 16px; overflow: hidden; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color); }
        .settings-item:last-child { border-bottom: none; }
        .settings-label { font-size: 15px; font-weight: 500; }
        .settings-value { color: var(--text-secondary); font-size: 14px; }
        .settings-btn { padding: 10px 16px; background: var(--accent-red); color: white; border: none; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; cursor: pointer; }
        @media (max-width: 380px) { .stat-value { font-size: 24px; } .stats-grid { gap: 8px; } }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-top">
                <div class="logo">
                    <div class="logo-mark">TD</div>
                    <div class="logo-text">Analytics <span>Pro</span></div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" id="refreshBtn" title="Refresh Data">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                    </button>
                    <button class="icon-btn" id="settingsBtn" title="Settings">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    </button>
                </div>
            </div>
            <div class="date-selector" id="dateSelector">
                <div class="date-chip active" data-range="today">Today</div>
                <div class="date-chip" data-range="7d">7 Days</div>
                <div class="date-chip" data-range="28d">28 Days</div>
                <div class="date-chip" data-range="90d">90 Days</div>
                <div class="date-chip" data-range="ytd">YTD</div>
            </div>
            <div class="filters-row" id="filtersRow">
                <div class="filter-dropdown" id="countryFilter">
                    <span class="filter-label">Country</span>
                    <span class="filter-value">All</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="filter-dropdown" id="cityFilter">
                    <span class="filter-label">City</span>
                    <span class="filter-value">All</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="filter-dropdown" id="sourceFilter">
                    <span class="filter-label">Source</span>
                    <span class="filter-value">All</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <button class="filter-clear" id="clearFilters">Clear</button>
            </div>
        </header>

        <main class="main-content" id="mainContent">
            <!-- Auth Screen -->
            <div class="auth-screen" id="authScreen">
                <div class="auth-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
                </div>
                <h1 class="auth-title">Connect Google Analytics</h1>
                <p class="auth-subtitle">Sign in to view your Tailor Digitals website analytics and AI-powered insights.</p>
                <button class="auth-btn" id="signInBtn">
                    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Sign in with Google
                </button>
            </div>

            <!-- Dashboard -->
            <div class="dashboard view-hidden" id="dashboard">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card"><div class="stat-label">Sessions</div><div class="stat-value" id="statSessions">--</div><div class="stat-change neutral" id="statSessionsChange">--</div></div>
                    <div class="stat-card"><div class="stat-label">Users</div><div class="stat-value" id="statUsers">--</div><div class="stat-change neutral" id="statUsersChange">--</div></div>
                    <div class="stat-card"><div class="stat-label">Bounce Rate</div><div class="stat-value" id="statBounce">--</div><div class="stat-change neutral" id="statBounceChange">--</div></div>
                    <div class="stat-card"><div class="stat-label">Avg. Duration</div><div class="stat-value" id="statDuration">--</div><div class="stat-change neutral" id="statDurationChange">--</div></div>
                </div>
                <section class="insights-section" id="insightsSection">
                    <div class="section-header"><h2 class="section-title">üß† AI Insights</h2></div>
                    <div id="insightsList"></div>
                </section>
                <section class="chart-section">
                    <div class="section-header"><h2 class="section-title">Traffic Trend</h2></div>
                    <div class="chart-container"><canvas id="trafficChart" class="chart-canvas"></canvas></div>
                </section>
                <section class="geo-section">
                    <div class="section-header"><h2 class="section-title">üìç Geographic Data</h2></div>
                    <div class="geo-map-preview"><div class="geo-hotspots" id="geoHotspots"></div></div>
                    <div class="geo-grid">
                        <div class="geo-card">
                            <div class="geo-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Countries</div>
                            <ul class="geo-list" id="geoCountries"></ul>
                        </div>
                        <div class="geo-card">
                            <div class="geo-card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4v18M19 21V11l-6-4M9 9v.01M9 12v.01M9 15v.01M9 18v.01"/></svg>Cities</div>
                            <ul class="geo-list" id="geoCities"></ul>
                        </div>
                    </div>
                </section>
                <section class="data-table-section"><div class="section-header"><h2 class="section-title">üîó Where They Came From</h2></div><div class="data-table" id="referralSourcesTable"></div></section>
                <section class="data-table-section"><div class="section-header"><h2 class="section-title">Top Pages</h2></div><div class="data-table" id="topPagesTable"></div></section>
                <section class="data-table-section"><div class="section-header"><h2 class="section-title">Traffic Sources</h2></div><div class="data-table" id="trafficSourcesTable"></div></section>
                <section class="data-table-section"><div class="section-header"><h2 class="section-title">Devices</h2></div><div class="data-table" id="devicesTable"></div></section>
            </div>

            <!-- Section Analytics Panel (NEW) -->
            <div class="view-hidden" id="sectionsPanel">
                <div class="section-header"><h2 class="section-title">üìê Section Analytics</h2></div>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">Which sections visitors scroll to and view on your site.</p>
                <div id="sectionViewsContainer">
                    <div class="section-empty">
                        <div class="section-empty-icon">üìê</div>
                        <div class="section-empty-title">Loading Section Data...</div>
                        <div class="section-empty-detail">Section view tracking data will appear here once data is collected.</div>
                    </div>
                </div>
                <div class="section-breakdown" id="sectionBreakdowns" style="display:none;">
                    <div class="section-header"><h2 class="section-title">Breakdown</h2></div>
                    <div class="section-breakdown-grid">
                        <div class="section-breakdown-card">
                            <div class="section-breakdown-title">üì± By Device</div>
                            <ul class="section-breakdown-list" id="sectionByDevice"></ul>
                        </div>
                        <div class="section-breakdown-card">
                            <div class="section-breakdown-title">üåç By Country</div>
                            <ul class="section-breakdown-list" id="sectionByCountry"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="settings-panel view-hidden" id="settingsPanel">
                <div class="section-header"><h2 class="section-title">Settings</h2></div>
                <div class="settings-group">
                    <div class="settings-item"><span class="settings-label">Connected Account</span><span class="settings-value" id="connectedEmail">--</span></div>
                    <div class="settings-item"><span class="settings-label">Property</span><span class="settings-value" id="connectedProperty">tailordigitals.com</span></div>
                    <div class="settings-item"><span class="settings-label">Last Sync</span><span class="settings-value" id="lastSync">--</span></div>
                </div>
                <div class="settings-group">
                    <div class="settings-item"><span class="settings-label">Sign Out</span><button class="settings-btn" id="signOutBtn">Disconnect</button></div>
                </div>
            </div>

            <div class="loading view-hidden" id="loadingState"><div class="loading-spinner"></div><p class="loading-text">Fetching your analytics...</p></div>
        </main>

        <div class="filter-modal-backdrop" id="filterBackdrop"></div>
        <div class="filter-modal" id="filterModal">
            <div class="filter-modal-header">
                <span class="filter-modal-title" id="filterModalTitle">Select Country</span>
                <button class="icon-btn" id="closeFilterModal"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            </div>
            <div class="filter-options" id="filterOptions"></div>
        </div>

        <!-- Tab Bar - 4 tabs now -->
        <nav class="tab-bar">
            <div class="tab-item active" data-tab="dashboard">
                <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
                <span class="tab-label">Dashboard</span>
            </div>
            <div class="tab-item" data-tab="sections">
                <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v4H3zM3 10h18v4H3zM3 17h18v4H3z"/></svg>
                <span class="tab-label">Sections</span>
            </div>
            <div class="tab-item" data-tab="insights">
                <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 2a10 10 0 0 1 10 10"/><circle cx="12" cy="12" r="6"/></svg>
                <span class="tab-label">Insights</span>
            </div>
            <div class="tab-item" data-tab="settings">
                <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"/></svg>
                <span class="tab-label">Settings</span>
            </div>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // ============================================
        // TD Analytics Pro - Updated Feb 2026
        // FIXED: Property ID, Filters, Section Analytics
        // ============================================

        const CONFIG = {
            CLIENT_ID: '89616736300-derj13fmb1dp057t1q10tpo4f8nhgbka.apps.googleusercontent.com',
            API_KEY: 'AIzaSyATDAD6FgtvyX4GZHOKrxPzlQ06aDBu5-c',
            PROPERTY_ID: 'properties/513422717',
            SCOPES: 'https://www.googleapis.com/auth/analytics.readonly',
            DISCOVERY_DOC: 'https://analyticsdata.googleapis.com/$discovery/rest?version=v1beta'
        };

        const state = {
            isSignedIn: false,
            currentRange: 'today',
            currentTab: 'dashboard',
            analyticsData: null,
            trafficChart: null,
            lastSync: null,
            filters: { country: null, city: null, source: null },
            filterOptions: { countries: [], cities: [], sources: [] },
            activeFilterType: null,
            sectionData: null
        };

        const dateRanges = {
            'today': { days: 0, label: 'Today', compare: 1 },
            '7d': { days: 7, label: 'Last 7 Days', compare: 7 },
            '28d': { days: 28, label: 'Last 28 Days', compare: 28 },
            '90d': { days: 90, label: 'Last 90 Days', compare: 90 },
            'ytd': { days: 'ytd', label: 'Year to Date', compare: 'ytd' }
        };

        // Section name display mapping
        const SECTION_LABELS = {
            'home': 'üè† Home / Hero',
            'why-choose-us': '‚≠ê Why Choose Us',
            'analytics': 'üìä Analytics Preview',
            'platforms': 'üîå Platforms',
            'approach': 'üéØ Our Approach',
            'expertise': 'üß† Expertise',
            'process': '‚öôÔ∏è Process',
            'about': 'üë§ About',
            'contact': 'üì¨ Contact'
        };

        let tokenClient, gapiInited = false, gisInited = false, accessToken = null, isFetching = false;
        const dataCache = {};
        const CACHE_DURATION = 60000;

        // ============================================
        // Google OAuth
        // ============================================
        function gapiLoaded() { if (gapiInited) return; gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() {
            if (gapiInited) return;
            try { await gapi.client.init({ apiKey: CONFIG.API_KEY }); } catch(e) {}
            gapiInited = true; maybeEnableButtons();
        }
        function gisLoaded() {
            if (gisInited) return;
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CONFIG.CLIENT_ID, scope: CONFIG.SCOPES, callback: '' });
            gisInited = true; maybeEnableButtons();
        }
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const token = localStorage.getItem('ga_token');
                const expiry = localStorage.getItem('ga_token_expiry');
                if (token && expiry && Date.now() < parseInt(expiry)) { accessToken = token; handleSignIn(); }
            }
        }
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) { alert('Auth failed: ' + (resp.error_description || resp.error)); return; }
                accessToken = resp.access_token;
                localStorage.setItem('ga_token', resp.access_token);
                localStorage.setItem('ga_token_expiry', Date.now() + (resp.expires_in * 1000));
                handleSignIn();
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        function handleSignIn() {
            state.isSignedIn = true;
            document.getElementById('authScreen').classList.add('view-hidden');
            document.getElementById('dashboard').classList.remove('view-hidden');
            fetchUserInfo();
            fetchAnalyticsData();
        }
        function handleSignOut() {
            if (accessToken) google.accounts.oauth2.revoke(accessToken);
            accessToken = null;
            localStorage.removeItem('ga_token');
            localStorage.removeItem('ga_token_expiry');
            state.isSignedIn = false;
            document.getElementById('authScreen').classList.remove('view-hidden');
            document.getElementById('dashboard').classList.add('view-hidden');
            document.getElementById('settingsPanel').classList.add('view-hidden');
            document.getElementById('sectionsPanel').classList.add('view-hidden');
            switchTab('dashboard');
        }
        async function fetchUserInfo() {
            try {
                const resp = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', { headers: { Authorization: `Bearer ${accessToken}` } });
                const data = await resp.json();
                document.getElementById('connectedEmail').textContent = data.email || 'Connected';
            } catch(e) {}
        }

        // ============================================
        // Date Range Helper
        // ============================================
        function getDateRange(rangeKey) {
            const today = new Date();
            const range = dateRanges[rangeKey];
            let startDate, endDate, compareStart, compareEnd;
            if (range.days === 'ytd') {
                startDate = new Date(today.getFullYear(), 0, 1); endDate = today;
                compareStart = new Date(today.getFullYear() - 1, 0, 1);
                compareEnd = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            } else if (range.days === 0) {
                startDate = today; endDate = today;
                const y = new Date(today); y.setDate(y.getDate() - 1); compareStart = y; compareEnd = y;
            } else {
                startDate = new Date(today); startDate.setDate(startDate.getDate() - range.days); endDate = today;
                compareStart = new Date(startDate); compareStart.setDate(compareStart.getDate() - range.days);
                compareEnd = new Date(startDate); compareEnd.setDate(compareEnd.getDate() - 1);
            }
            const f = (d) => d.toISOString().split('T')[0];
            return { current: { start: f(startDate), end: f(endDate) }, previous: { start: f(compareStart), end: f(compareEnd) } };
        }

        // ============================================
        // GA4 API - With Filter Support
        // ============================================
        function buildDimensionFilter() {
            const filters = [];
            if (state.filters.country) filters.push({ filter: { fieldName: 'country', stringFilter: { matchType: 'EXACT', value: state.filters.country } } });
            if (state.filters.city) filters.push({ filter: { fieldName: 'city', stringFilter: { matchType: 'EXACT', value: state.filters.city } } });
            if (state.filters.source) filters.push({ filter: { fieldName: 'sessionSource', stringFilter: { matchType: 'EXACT', value: state.filters.source } } });
            if (filters.length === 0) return null;
            if (filters.length === 1) return filters[0];
            return { andGroup: { expressions: filters } };
        }

        async function runGA4Report(startDate, endDate, dimensions = [], metrics = ['sessions', 'totalUsers', 'bounceRate', 'averageSessionDuration', 'screenPageViews'], extraFilter = null) {
            try {
                if (!accessToken) throw new Error('No access token');
                const body = { dateRanges: [{ startDate, endDate }], metrics: metrics.map(m => ({ name: m })) };
                if (dimensions.length > 0) body.dimensions = dimensions.map(d => ({ name: d }));
                const dimFilter = extraFilter || buildDimensionFilter();
                if (dimFilter) body.dimensionFilter = dimFilter;
                const resp = await fetch(`https://analyticsdata.googleapis.com/v1beta/${CONFIG.PROPERTY_ID}:runReport`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                });
                if (!resp.ok) { const e = await resp.json().catch(() => ({})); throw new Error(e.error?.message || `HTTP ${resp.status}`); }
                return parseGA4Response(await resp.json(), dimensions, metrics);
            } catch (err) { console.error('GA4 Error:', err); return { totals: {}, rows: [] }; }
        }

        async function runGA4ReportWithDate(startDate, endDate) {
            try {
                if (!accessToken) throw new Error('No access token');
                const body = { dateRanges: [{ startDate, endDate }], dimensions: [{ name: 'date' }], metrics: [{ name: 'sessions' }, { name: 'totalUsers' }], orderBys: [{ dimension: { dimensionName: 'date' } }] };
                const dimFilter = buildDimensionFilter();
                if (dimFilter) body.dimensionFilter = dimFilter;
                const resp = await fetch(`https://analyticsdata.googleapis.com/v1beta/${CONFIG.PROPERTY_ID}:runReport`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                });
                if (!resp.ok) { const e = await resp.json().catch(() => ({})); throw new Error(e.error?.message || `HTTP ${resp.status}`); }
                return parseGA4Response(await resp.json(), ['date'], ['sessions', 'totalUsers']);
            } catch (err) { console.error('GA4 daily error:', err); return { totals: {}, rows: [] }; }
        }

        function parseGA4Response(result, dimensions, metrics) {
            if (!result) return { totals: {}, rows: [] };
            const totals = {}, rows = [];
            if (result.rows && result.rows.length > 0) {
                result.rows.forEach(row => {
                    const item = {};
                    if (row.dimensionValues && dimensions.length > 0) row.dimensionValues.forEach((v, i) => { if (dimensions[i]) item[dimensions[i]] = v.value; });
                    if (row.metricValues) row.metricValues.forEach((v, i) => { if (metrics[i]) item[metrics[i]] = parseFloat(v.value) || 0; });
                    rows.push(item);
                });
            }
            if (dimensions.length === 0 && rows.length > 0) { metrics.forEach(m => { if (rows[0][m] !== undefined) totals[m] = rows[0][m]; }); }
            else if (result.totals && result.totals[0] && result.totals[0].metricValues) { result.totals[0].metricValues.forEach((v, i) => { if (metrics[i]) totals[metrics[i]] = parseFloat(v.value) || 0; }); }
            else if (rows.length > 0) { metrics.forEach(m => { if (m === 'bounceRate' || m === 'averageSessionDuration') { const vals = rows.map(r => r[m] || 0).filter(v => v > 0); totals[m] = vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0; } else { totals[m] = rows.reduce((acc, r) => acc + (r[m] || 0), 0); } }); }
            return { totals, rows };
        }

        // ============================================
        // Fetch All Data
        // ============================================
        async function fetchAnalyticsData(forceRefresh = false) {
            if (isFetching) return;
            isFetching = true;
            showLoading(true);
            const dates = getDateRange(state.currentRange);
            try {
                const [current, previous, topPages, trafficSources, devices, dailyData, geoCountries, geoCities, referrals] = await Promise.all([
                    runGA4Report(dates.current.start, dates.current.end),
                    runGA4Report(dates.previous.start, dates.previous.end),
                    runGA4Report(dates.current.start, dates.current.end, ['pagePath'], ['screenPageViews', 'averageSessionDuration', 'bounceRate']),
                    runGA4Report(dates.current.start, dates.current.end, ['sessionSource'], ['sessions', 'totalUsers']),
                    runGA4Report(dates.current.start, dates.current.end, ['deviceCategory'], ['sessions', 'totalUsers']),
                    runGA4ReportWithDate(dates.current.start, dates.current.end),
                    runGA4Report(dates.current.start, dates.current.end, ['country'], ['sessions', 'totalUsers']),
                    runGA4Report(dates.current.start, dates.current.end, ['city'], ['sessions', 'totalUsers']),
                    runGA4Report(dates.current.start, dates.current.end, ['sessionSourceMedium'], ['sessions', 'totalUsers', 'bounceRate'])
                ]);

                state.analyticsData = { current, previous, topPages, trafficSources, devices, dailyData, geoCountries, geoCities, referrals };
                state.filterOptions.countries = (geoCountries?.rows || []).map(r => r.country).filter(Boolean);
                state.filterOptions.cities = (geoCities?.rows || []).map(r => r.city).filter(Boolean);
                state.filterOptions.sources = (trafficSources?.rows || []).map(r => r.sessionSource).filter(Boolean);
                state.lastSync = new Date();
                document.getElementById('lastSync').textContent = state.lastSync.toLocaleTimeString();
                renderDashboard(); renderGeoData(); generateInsights();

                // Fetch section data separately (no user filters applied - event-level data)
                await fetchSectionData(dates.current.start, dates.current.end);
            } catch (err) {
                console.error('Fetch error:', err);
                alert('Error: ' + (err.message || 'Failed to fetch data'));
            } finally { isFetching = false; showLoading(false); }
        }

        // ============================================
        // Section Analytics Data
        // ============================================
        async function fetchSectionData(startDate, endDate) {
            try {
                // Event filter: only section_view events
                const eventFilter = { filter: { fieldName: 'eventName', stringFilter: { matchType: 'EXACT', value: 'section_view' } } };

                const [bySection, byDevice, byCountry] = await Promise.all([
                    runGA4Report(startDate, endDate, ['customEvent:section_name'], ['eventCount'], eventFilter),
                    runGA4Report(startDate, endDate, ['customEvent:section_name', 'deviceCategory'], ['eventCount'], eventFilter),
                    runGA4Report(startDate, endDate, ['customEvent:section_name', 'country'], ['eventCount'], eventFilter)
                ]);

                state.sectionData = { bySection, byDevice, byCountry };
                renderSectionAnalytics();
            } catch (err) {
                console.error('Section data error:', err);
                // Try alternate dimension name (without customEvent: prefix)
                try {
                    const eventFilter = { filter: { fieldName: 'eventName', stringFilter: { matchType: 'EXACT', value: 'section_view' } } };
                    const [bySection, byDevice, byCountry] = await Promise.all([
                        runGA4Report(startDate, endDate, ['eventName'], ['eventCount'], eventFilter),
                        runGA4Report(startDate, endDate, ['eventName', 'deviceCategory'], ['eventCount'], eventFilter),
                        runGA4Report(startDate, endDate, ['eventName', 'country'], ['eventCount'], eventFilter)
                    ]);
                    state.sectionData = { bySection, byDevice, byCountry };
                    renderSectionAnalytics();
                } catch (err2) { console.error('Section fallback error:', err2); }
            }
        }

        function renderSectionAnalytics() {
            const container = document.getElementById('sectionViewsContainer');
            const breakdowns = document.getElementById('sectionBreakdowns');
            if (!state.sectionData || !state.sectionData.bySection || !state.sectionData.bySection.rows || state.sectionData.bySection.rows.length === 0) {
                container.innerHTML = `<div class="section-empty"><div class="section-empty-icon">üìê</div><div class="section-empty-title">No Section Data Yet</div><div class="section-empty-detail">Section view tracking was just set up. Data will appear here once visitors start browsing your site. Check back in a few hours.</div></div>`;
                breakdowns.style.display = 'none';
                return;
            }

            const rows = state.sectionData.bySection.rows.sort((a, b) => (b.eventCount || 0) - (a.eventCount || 0));
            const totalViews = rows.reduce((sum, r) => sum + (r.eventCount || 0), 0);
            const maxViews = rows[0]?.eventCount || 1;

            container.innerHTML = `<div class="section-analytics-grid">${rows.map(row => {
                const name = row['customEvent:section_name'] || row.eventName || 'unknown';
                const label = SECTION_LABELS[name] || name;
                const count = row.eventCount || 0;
                const pct = totalViews > 0 ? ((count / totalViews) * 100).toFixed(1) : '0.0';
                const barWidth = ((count / maxViews) * 100).toFixed(0);
                return `<div class="section-row">
                    <div class="section-row-left">
                        <div class="section-row-name">${label}</div>
                        <div class="section-row-bar"><div class="section-row-bar-fill" style="width: ${barWidth}%"></div></div>
                    </div>
                    <div class="section-row-right">
                        <div class="section-row-count">${count}</div>
                        <div class="section-row-pct">${pct}% of views</div>
                    </div>
                </div>`;
            }).join('')}</div>`;

            // Render breakdowns
            breakdowns.style.display = 'block';

            // By Device
            const deviceContainer = document.getElementById('sectionByDevice');
            if (state.sectionData.byDevice?.rows?.length > 0) {
                const deviceAgg = {};
                state.sectionData.byDevice.rows.forEach(r => {
                    const dev = r.deviceCategory || 'unknown';
                    deviceAgg[dev] = (deviceAgg[dev] || 0) + (r.eventCount || 0);
                });
                const sorted = Object.entries(deviceAgg).sort((a, b) => b[1] - a[1]);
                deviceContainer.innerHTML = sorted.map(([dev, count]) => `<li class="section-breakdown-item"><span>${dev}</span><span class="section-breakdown-item-val">${count}</span></li>`).join('');
            }

            // By Country
            const countryContainer = document.getElementById('sectionByCountry');
            if (state.sectionData.byCountry?.rows?.length > 0) {
                const countryAgg = {};
                state.sectionData.byCountry.rows.forEach(r => {
                    const c = r.country || 'unknown';
                    countryAgg[c] = (countryAgg[c] || 0) + (r.eventCount || 0);
                });
                const sorted = Object.entries(countryAgg).sort((a, b) => b[1] - a[1]).slice(0, 5);
                countryContainer.innerHTML = sorted.map(([c, count]) => `<li class="section-breakdown-item"><span>${c}</span><span class="section-breakdown-item-val">${count}</span></li>`).join('');
            }
        }

        // ============================================
        // Dashboard Rendering
        // ============================================
        function renderDashboard() {
            if (!state.analyticsData) return;
            const { current, previous } = state.analyticsData;
            if (!current?.totals || !previous?.totals) return;
            updateStatCard('Sessions', current.totals.sessions || 0, previous.totals.sessions || 0, 'statSessions', 'statSessionsChange');
            updateStatCard('Users', current.totals.totalUsers || 0, previous.totals.totalUsers || 0, 'statUsers', 'statUsersChange');
            updateStatCard('Bounce', current.totals.bounceRate || 0, previous.totals.bounceRate || 0, 'statBounce', 'statBounceChange', true, true);
            updateStatCard('Duration', current.totals.averageSessionDuration || 0, previous.totals.averageSessionDuration || 0, 'statDuration', 'statDurationChange', false, false, true);
            renderTopPages(); renderTrafficSources(); renderDevices(); renderTrafficChart();
        }

        function updateStatCard(label, currentVal, previousVal, valueId, changeId, isPercent = false, inverseGood = false, isTime = false) {
            const el = document.getElementById(valueId), chEl = document.getElementById(changeId);
            if (!el || !chEl) return;
            const cur = Number(currentVal) || 0, prev = Number(previousVal) || 0;
            let display;
            if (isPercent) display = (cur * 100).toFixed(1) + '%';
            else if (isTime) { const m = Math.floor(cur / 60), s = Math.floor(cur % 60); display = `${m}:${s.toString().padStart(2, '0')}`; }
            else display = formatNumber(cur);
            el.textContent = display;
            const change = prev > 0 ? ((cur - prev) / prev) * 100 : 0;
            let cls = 'neutral';
            if (change > 0) cls = inverseGood ? 'negative' : 'positive';
            if (change < 0) cls = inverseGood ? 'positive' : 'negative';
            chEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(1) + '%';
            chEl.className = `stat-change ${cls}`;
        }

        function formatNumber(n) { if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'K'; return Math.round(n).toLocaleString(); }

        function renderTopPages() {
            const c = document.getElementById('topPagesTable'); if (!c || !state.analyticsData?.topPages?.rows) return;
            c.innerHTML = state.analyticsData.topPages.rows.slice(0,5).map((r,i) => `<div class="table-row"><div class="table-label"><span class="table-rank">${i+1}</span><span class="table-name">${r.pagePath||'/'}</span></div><div class="table-value">${formatNumber(r.screenPageViews||0)}</div></div>`).join('');
        }
        function renderTrafficSources() {
            const c = document.getElementById('trafficSourcesTable'); if (!c || !state.analyticsData?.trafficSources?.rows) return;
            c.innerHTML = state.analyticsData.trafficSources.rows.slice(0,5).map((r,i) => `<div class="table-row"><div class="table-label"><span class="table-rank">${i+1}</span><span class="table-name">${r.sessionSource||'Unknown'}</span></div><div class="table-value">${formatNumber(r.sessions||0)}</div></div>`).join('');
        }
        function renderDevices() {
            const c = document.getElementById('devicesTable'); if (!c || !state.analyticsData?.devices?.rows) return;
            const rows = state.analyticsData.devices.rows, total = rows.reduce((s,r) => s + (r.sessions||0), 0);
            if (!total) return;
            c.innerHTML = rows.map((r,i) => `<div class="table-row"><div class="table-label"><span class="table-rank">${i+1}</span><span class="table-name">${r.deviceCategory||'Unknown'}</span></div><div class="table-value">${(((r.sessions||0)/total)*100).toFixed(1)}%</div></div>`).join('');
        }
        function renderTrafficChart() {
            const ctx = document.getElementById('trafficChart'); if (!ctx || !state.analyticsData?.dailyData?.rows?.length) return;
            if (state.trafficChart) state.trafficChart.destroy();
            const data = state.analyticsData.dailyData.rows;
            state.trafficChart = new Chart(ctx.getContext('2d'), {
                type: 'line', data: { labels: data.map(r => { const d=r.date||''; return d.length>=8?`${d.slice(4,6)}/${d.slice(6,8)}`:''; }),
                    datasets: [{ label: 'Sessions', data: data.map(r => r.sessions||0), borderColor: '#9945ff', backgroundColor: 'rgba(153,69,255,0.1)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 },
                        { label: 'Users', data: data.map(r => r.totalUsers||0), borderColor: '#00e5ff', backgroundColor: 'transparent', tension: 0.4, pointRadius: 0, borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { display: true, position: 'top', align: 'end', labels: { color: '#9090a8', usePointStyle: true, padding: 15, font: { size: 11 } } },
                        tooltip: { backgroundColor: '#0f0f18', titleColor: '#f5f5fa', bodyColor: '#9090a8', borderColor: 'rgba(153,69,255,0.2)', borderWidth: 1, padding: 12 } },
                    scales: { x: { grid: { color: 'rgba(153,69,255,0.05)' }, ticks: { color: '#505068', font: { size: 10 } } }, y: { grid: { color: 'rgba(153,69,255,0.05)' }, ticks: { color: '#505068', font: { size: 10 } } } } }
            });
        }

        // ============================================
        // AI Insights (keeping all 13 insights from original)
        // ============================================
        function generateInsights() {
            if (!state.analyticsData?.current?.totals || !state.analyticsData?.previous?.totals) return;
            const insights = [];
            const { current, previous, topPages, trafficSources, devices, dailyData } = state.analyticsData;
            const cs = current.totals.sessions||0, ps = previous.totals.sessions||0;
            const tc = ps > 0 ? ((cs-ps)/ps)*100 : 0;
            if (tc < -20) insights.push({ type:'critical', title:'Significant Traffic Drop', detail:`Sessions down <span class="insight-metric">${Math.abs(tc).toFixed(1)}%</span>. Investigate causes.`, badge:'CRITICAL' });
            else if (tc > 30) insights.push({ type:'success', title:'Traffic Surge', detail:`Sessions up <span class="insight-metric">${tc.toFixed(1)}%</span>! Review what's driving growth.`, badge:'GROWTH' });
            const br = (current.totals.bounceRate||0)*100;
            if (br > 70) insights.push({ type:'warning', title:'High Bounce Rate', detail:`Bounce rate is <span class="insight-metric">${br.toFixed(1)}%</span> (above 40-60% standard). Improve load speed & content relevance.`, badge:'ATTENTION' });
            else if (br > 0 && br < 30) insights.push({ type:'success', title:'Excellent Engagement', detail:`<span class="insight-metric">${br.toFixed(1)}%</span> bounce rate ‚Äî visitors are exploring.`, badge:'WINNING' });
            const ad = current.totals.averageSessionDuration||0;
            if (ad > 0 && ad < 30) insights.push({ type:'warning', title:'Low Session Duration', detail:`Average <span class="insight-metric">${Math.floor(ad)}s</span>. Add interactive content & clear CTAs.`, badge:'IMPROVE' });
            else if (ad > 180) insights.push({ type:'success', title:'Strong Engagement', detail:`<span class="insight-metric">${Math.floor(ad/60)}m ${Math.floor(ad%60)}s</span> average session.`, badge:'EXCELLENT' });
            if (devices?.rows?.length >= 2) {
                const mob = devices.rows.find(r => r.deviceCategory==='mobile'), desk = devices.rows.find(r => r.deviceCategory==='desktop');
                if (mob?.sessions && desk?.sessions) { const ms = mob.sessions/(mob.sessions+desk.sessions)*100; if (ms > 60) insights.push({ type:'info', title:'Mobile-Dominant', detail:`<span class="insight-metric">${ms.toFixed(0)}%</span> mobile traffic. Prioritize mobile UX.`, badge:'MOBILE' }); }
            }
            if (trafficSources?.rows?.length > 0) {
                const ts = trafficSources.rows, tot = ts.reduce((s,r) => s+(r.sessions||0),0);
                if (tot > 0 && ts[0].sessions) { const share = (ts[0].sessions/tot)*100; if (share > 70) insights.push({ type:'warning', title:'Traffic Concentration Risk', detail:`<span class="insight-metric">${share.toFixed(0)}%</span> from "${ts[0].sessionSource}". Diversify channels.`, badge:'RISK' }); }
            }
            if (state.analyticsData.geoCountries?.rows?.length > 0) {
                const gr = state.analyticsData.geoCountries.rows, tg = gr.reduce((s,r)=>s+(r.sessions||0),0);
                if (tg > 0 && gr[0]?.sessions) { const share = (gr[0].sessions/tg)*100; if (share > 80) insights.push({ type:'info', title:'Single Market Dominance', detail:`<span class="insight-metric">${share.toFixed(0)}%</span> from ${gr[0].country}.`, badge:'GEO' }); }
            }
            if (state.analyticsData.geoCities?.rows?.length >= 3) {
                const top = state.analyticsData.geoCities.rows.slice(0,3).map(c=>c.city).filter(c=>c&&c!=='(not set)').join(', ');
                if (top) insights.push({ type:'info', title:'Top City Clusters', detail:`Top visitors: <span class="insight-metric">${top}</span>. Consider geo-targeted ads.`, badge:'LOCAL' });
            }
            renderInsights(insights.length > 0 ? insights : [{ type:'info', title:'No Critical Insights', detail:'Analytics look stable. Keep monitoring.', badge:'INFO' }]);
        }
        function renderInsights(insights) {
            document.getElementById('insightsList').innerHTML = insights.map(i => `<div class="insight-card ${i.type}"><span class="insight-badge">${i.badge}</span><h3 class="insight-title">${i.title}</h3><p class="insight-detail">${i.detail}</p></div>`).join('');
        }

        // ============================================
        // Geo Rendering
        // ============================================
        function renderGeoData() {
            if (!state.analyticsData) return;
            const { geoCountries, geoCities, referrals } = state.analyticsData;
            if (geoCountries?.rows?.length > 0) { renderGeoHotspots(geoCountries.rows.slice(0,4)); renderGeoList('geoCountries', geoCountries.rows.slice(0,5), 'country'); }
            if (geoCities?.rows?.length > 0) renderGeoList('geoCities', geoCities.rows.slice(0,5), 'city');
            if (referrals?.rows?.length > 0) renderReferralSources(referrals.rows.slice(0,6));
        }
        function renderGeoHotspots(countries) {
            const flags = {'United States':'üá∫üá∏','Canada':'üá®üá¶','United Kingdom':'üá¨üáß','Germany':'üá©üá™','Australia':'üá¶üá∫','France':'üá´üá∑','India':'üáÆüá≥','Brazil':'üáßüá∑','Mexico':'üá≤üáΩ','Japan':'üáØüáµ'};
            document.getElementById('geoHotspots').innerHTML = countries.map(c => `<div class="geo-hotspot"><span class="geo-hotspot-dot"></span><span>${flags[c.country]||'üåç'} ${c.country}</span><span style="color:var(--accent-cyan);font-family:'JetBrains Mono',monospace;">${c.sessions}</span></div>`).join('');
        }
        function renderGeoList(id, rows, dim) {
            const c = document.getElementById(id); if (!c || !rows?.length) return;
            const total = rows.reduce((s,r)=>s+(r.sessions||0),0); if (!total) return;
            const flags = {'United States':'üá∫üá∏','Canada':'üá®üá¶','United Kingdom':'üá¨üáß','Germany':'üá©üá™','Australia':'üá¶üá∫','France':'üá´üá∑','India':'üáÆüá≥'};
            c.innerHTML = rows.map(r => { const name=r[dim]||'Unknown', flag=dim==='country'?(flags[name]||'üåç'):'üìç', pct=((r.sessions/total)*100).toFixed(1);
                return `<li class="geo-item" data-ft="${dim}" data-fv="${name}"><span class="geo-item-name"><span class="geo-flag">${flag}</span>${name}</span><span class="geo-item-value">${pct}%</span></li>`; }).join('');
            c.querySelectorAll('.geo-item').forEach(item => item.addEventListener('click', () => applyFilter(item.dataset.ft, item.dataset.fv)));
        }
        function renderReferralSources(rows) {
            const c = document.getElementById('referralSourcesTable');
            const icons = {'google':'üîç','direct':'‚û°Ô∏è','linkedin':'üíº','facebook':'üìò','twitter':'üê¶','bing':'üîé'};
            c.innerHTML = rows.map(r => { const sm=r.sessionSourceMedium||'unknown', src=sm.split(' / ')[0]; return `<div class="table-row"><div class="table-label"><span class="table-rank">${icons[src.toLowerCase()]||'üîó'}</span><span class="table-name">${sm}</span></div><div class="table-value">${formatNumber(r.sessions)}</div></div>`; }).join('');
        }

        // ============================================
        // Filter System (NOW ACTUALLY WORKS)
        // ============================================
        function applyFilter(type, value) {
            state.filters[type] = value;
            updateFilterUI();
            if (state.isSignedIn) fetchAnalyticsData(true);
        }
        function clearFilters() {
            state.filters = { country: null, city: null, source: null };
            updateFilterUI();
            if (state.isSignedIn) fetchAnalyticsData(true);
        }
        function updateFilterUI() {
            ['country','city','source'].forEach(type => {
                const el = document.getElementById(type+'Filter');
                el.querySelector('.filter-value').textContent = state.filters[type] || 'All';
                el.classList.toggle('active', !!state.filters[type]);
            });
        }
        function openFilterModal(type) {
            state.activeFilterType = type;
            const modal = document.getElementById('filterModal'), backdrop = document.getElementById('filterBackdrop');
            document.getElementById('filterModalTitle').textContent = {country:'Select Country',city:'Select City',source:'Select Source'}[type];
            const list = state.filterOptions[type+'s'] || state.filterOptions[type === 'source' ? 'sources' : type+'ies'] || [];
            const opts = type === 'country' ? state.filterOptions.countries : type === 'city' ? state.filterOptions.cities : state.filterOptions.sources;
            document.getElementById('filterOptions').innerHTML = `<div class="filter-option ${!state.filters[type]?'selected':''}" data-value="">All</div>` + opts.map(o => `<div class="filter-option ${state.filters[type]===o?'selected':''}" data-value="${o}">${o}</div>`).join('');
            document.getElementById('filterOptions').querySelectorAll('.filter-option').forEach(o => o.addEventListener('click', () => { applyFilter(type, o.dataset.value || null); closeFilterModal(); }));
            modal.classList.add('open'); backdrop.classList.add('open');
        }
        function closeFilterModal() { document.getElementById('filterModal').classList.remove('open'); document.getElementById('filterBackdrop').classList.remove('open'); }

        // ============================================
        // UI & Navigation
        // ============================================
        function showLoading(show) {
            document.getElementById('loadingState').classList.toggle('view-hidden', !show);
            if (state.isSignedIn) {
                const tab = state.currentTab;
                document.getElementById('dashboard').classList.toggle('view-hidden', show || (tab !== 'dashboard' && tab !== 'insights'));
                document.getElementById('sectionsPanel').classList.toggle('view-hidden', show || tab !== 'sections');
            }
        }
        function switchTab(tabName) {
            state.currentTab = tabName;
            document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
            document.getElementById('dashboard').classList.toggle('view-hidden', tabName !== 'dashboard' && tabName !== 'insights');
            document.getElementById('sectionsPanel').classList.toggle('view-hidden', tabName !== 'sections');
            document.getElementById('settingsPanel').classList.toggle('view-hidden', tabName !== 'settings');
            if (tabName === 'insights') document.getElementById('insightsSection')?.scrollIntoView({ behavior: 'smooth' });
            if (tabName === 'sections' && state.sectionData) renderSectionAnalytics();
        }

        // ============================================
        // Init
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('signInBtn').addEventListener('click', handleAuthClick);
            document.getElementById('signOutBtn').addEventListener('click', handleSignOut);
            document.getElementById('refreshBtn').addEventListener('click', () => { if (state.isSignedIn) fetchAnalyticsData(true); });
            document.getElementById('settingsBtn').addEventListener('click', () => switchTab('settings'));
            document.querySelectorAll('.date-chip').forEach(chip => chip.addEventListener('click', () => {
                document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active'); state.currentRange = chip.dataset.range;
                if (state.isSignedIn) fetchAnalyticsData(true);
            }));
            document.querySelectorAll('.tab-item').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));
            document.getElementById('countryFilter').addEventListener('click', () => openFilterModal('country'));
            document.getElementById('cityFilter').addEventListener('click', () => openFilterModal('city'));
            document.getElementById('sourceFilter').addEventListener('click', () => openFilterModal('source'));
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('closeFilterModal').addEventListener('click', closeFilterModal);
            document.getElementById('filterBackdrop').addEventListener('click', closeFilterModal);

            let attempts = 0;
            function initAPIs() {
                attempts++;
                if (typeof gapi !== 'undefined' && !gapiInited) gapiLoaded();
                if (typeof google !== 'undefined' && google.accounts && !gisInited) gisLoaded();
                if ((!gapiInited || !gisInited) && attempts < 50) setTimeout(initAPIs, 100);
            }
            initAPIs();
        });
        window.addEventListener('load', () => {
            if (typeof gapi !== 'undefined' && !gapiInited) gapiLoaded();
            if (typeof google !== 'undefined' && google.accounts && !gisInited) gisLoaded();
        });
    </script>
</body>
</html>
